<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SpringCloud Alibaba | Hello VuePress</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.bba7ace1.css" as="style"><link rel="preload" href="/assets/js/app.ff72da0a.js" as="script"><link rel="preload" href="/assets/js/2.bafebcf4.js" as="script"><link rel="preload" href="/assets/js/10.8d41c55a.js" as="script"><link rel="prefetch" href="/assets/js/11.fdb6a570.js"><link rel="prefetch" href="/assets/js/12.146efa25.js"><link rel="prefetch" href="/assets/js/13.76c1c2f0.js"><link rel="prefetch" href="/assets/js/3.f5992324.js"><link rel="prefetch" href="/assets/js/4.1d1a9ca2.js"><link rel="prefetch" href="/assets/js/5.f866cbb4.js"><link rel="prefetch" href="/assets/js/6.37a4bfd9.js"><link rel="prefetch" href="/assets/js/7.6d30757c.js"><link rel="prefetch" href="/assets/js/8.f3235214.js"><link rel="prefetch" href="/assets/js/9.daae8f88.js">
    <link rel="stylesheet" href="/assets/css/0.styles.bba7ace1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Hello VuePress</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow down"></span></button> <button type="button" aria-label="Spring" class="mobile-dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Spring/SpringCloud/" class="nav-link">
  SpringCloud
</a></li><li class="dropdown-item"><!----> <a href="/Spring/SpringCloud Alibaba/" class="nav-link">
  SpringCloud Alibaba
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><span class="title">运维</span> <span class="arrow down"></span></button> <button type="button" aria-label="运维" class="mobile-dropdown-title"><span class="title">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/operation/Linux/" class="nav-link">
  Linux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="消息中间件" class="dropdown-title"><span class="title">消息中间件</span> <span class="arrow down"></span></button> <button type="button" aria-label="消息中间件" class="mobile-dropdown-title"><span class="title">消息中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/middleware/RabbitMQ/" class="nav-link">
  RabbitMQ
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="NoSQL" class="dropdown-title"><span class="title">NoSQL</span> <span class="arrow down"></span></button> <button type="button" aria-label="NoSQL" class="mobile-dropdown-title"><span class="title">NoSQL</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/NoSQL/Redis/" class="nav-link">
  Redis
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow down"></span></button> <button type="button" aria-label="Spring" class="mobile-dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Spring/SpringCloud/" class="nav-link">
  SpringCloud
</a></li><li class="dropdown-item"><!----> <a href="/Spring/SpringCloud Alibaba/" class="nav-link">
  SpringCloud Alibaba
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><span class="title">运维</span> <span class="arrow down"></span></button> <button type="button" aria-label="运维" class="mobile-dropdown-title"><span class="title">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/operation/Linux/" class="nav-link">
  Linux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="消息中间件" class="dropdown-title"><span class="title">消息中间件</span> <span class="arrow down"></span></button> <button type="button" aria-label="消息中间件" class="mobile-dropdown-title"><span class="title">消息中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/middleware/RabbitMQ/" class="nav-link">
  RabbitMQ
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="NoSQL" class="dropdown-title"><span class="title">NoSQL</span> <span class="arrow down"></span></button> <button type="button" aria-label="NoSQL" class="mobile-dropdown-title"><span class="title">NoSQL</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/NoSQL/Redis/" class="nav-link">
  Redis
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>SpringCloud Alibaba</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Spring/SpringCloud%20Alibaba.html#springcloud-alibaba-nacos服务注册和配置中心" class="sidebar-link">SpringCloud Alibaba Nacos服务注册和配置中心</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Spring/SpringCloud%20Alibaba.html#注册中心使用" class="sidebar-link">注册中心使用</a></li><li class="sidebar-sub-header"><a href="/Spring/SpringCloud%20Alibaba.html#配置中心使用" class="sidebar-link">配置中心使用</a></li><li class="sidebar-sub-header"><a href="/Spring/SpringCloud%20Alibaba.html#分类配置" class="sidebar-link">分类配置</a></li><li class="sidebar-sub-header"><a href="/Spring/SpringCloud%20Alibaba.html#共享配置-shared-configs-和扩展配-extension-config" class="sidebar-link">共享配置(shared-configs)和扩展配(extension-config)</a></li></ul></li><li><a href="/Spring/SpringCloud%20Alibaba.html#springcloud-alibaba-sentinel服务降级熔断与限流" class="sidebar-link">SpringCloud Alibaba Sentinel服务降级熔断与限流</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Spring/SpringCloud%20Alibaba.html#流控规则" class="sidebar-link">流控规则</a></li><li class="sidebar-sub-header"><a href="/Spring/SpringCloud%20Alibaba.html#流控模式" class="sidebar-link">流控模式</a></li><li class="sidebar-sub-header"><a href="/Spring/SpringCloud%20Alibaba.html#流控效果" class="sidebar-link">流控效果</a></li><li class="sidebar-sub-header"><a href="/Spring/SpringCloud%20Alibaba.html#降级规则" class="sidebar-link">降级规则</a></li><li class="sidebar-sub-header"><a href="/Spring/SpringCloud%20Alibaba.html#热点key限流" class="sidebar-link">热点key限流</a></li><li class="sidebar-sub-header"><a href="/Spring/SpringCloud%20Alibaba.html#系统规则" class="sidebar-link">系统规则</a></li><li class="sidebar-sub-header"><a href="/Spring/SpringCloud%20Alibaba.html#sentinelresource" class="sidebar-link">@SentinelResource</a></li><li class="sidebar-sub-header"><a href="/Spring/SpringCloud%20Alibaba.html#规则持久化" class="sidebar-link">规则持久化</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="springcloud-alibaba"><a href="#springcloud-alibaba" class="header-anchor">#</a> SpringCloud Alibaba</h1> <h2 id="springcloud-alibaba-nacos服务注册和配置中心"><a href="#springcloud-alibaba-nacos服务注册和配置中心" class="header-anchor">#</a> SpringCloud Alibaba Nacos服务注册和配置中心</h2> <h3 id="注册中心使用"><a href="#注册中心使用" class="header-anchor">#</a> 注册中心使用</h3> <p>运行nacos客户端</p> <p>改POM</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>改yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment">#配置Nacos地址</span>
</code></pre></div><p>主启动加入@EnableDiscoveryClient注解</p> <h3 id="配置中心使用"><a href="#配置中心使用" class="header-anchor">#</a> 配置中心使用</h3> <p>改POM</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>改yml，Nacos同springcloud-config一样，在项目初始化时，要保证先从配置中心进行配置拉取，拉取配置之后，才能保证项目的正常启动。springboot中配置文件的加载是存在优先级顺序的，bootstrap优先级高于application。bootstrap.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment">#服务注册中心地址</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment">#配置中心地址</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment">#指定yaml格式的配置（yml和yaml都可以）</span>
        <span class="token comment"># 命名空间</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 508abb0a<span class="token punctuation">-</span>1cac<span class="token punctuation">-</span>49d6<span class="token punctuation">-</span>83f1<span class="token punctuation">-</span>f6e3f7b804c5
        <span class="token comment"># 分组</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> dev_group2
<span class="token comment">#${spring.application.name}-${spring.profiles.active}.${spring.cloud.nacos.config.file-extension}</span>
<span class="token comment">#nacos-config-client-dev.yaml  (一定要与file-extension值保持一致)</span>
</code></pre></div><p>application.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
	<span class="token key atrule">profiles</span><span class="token punctuation">:</span>
		<span class="token key atrule">active</span><span class="token punctuation">:</span> dev
</code></pre></div><p>主启动加入@EnableDiscoveryClient注解,调用类加入@RefreshScopee实现配置自动更新</p> <blockquote><p>云上的配置文件名称要和这个一致</p> <p>${spring.application.name}-${spring.profiles.active}.${spring.cloud.nacos.config.file-extension}</p></blockquote> <h3 id="分类配置"><a href="#分类配置" class="header-anchor">#</a> 分类配置</h3> <p>Namespace+Group+Data ID三者完成分类配置</p> <p>默认情况：Namespace=public，Group=DEFAULT_GROUP，默认Cluster是DEFAULT，Data ID就是配置文件的名称</p> <ol><li>Nacos默认的命名空间是public，Namespace主要用来实现隔离。比方说我们现在有三个环境：<strong>开发、测试、生产环境</strong>，我们就可以创建三个Namespace，不同的 Namespace之间是隔离的。</li> <li>Group默认是<strong>DEFAULT_GROUP</strong>，Group可以把不同的微服务划分到同一个分组里面去。Service就是微服务，一个Service可以包含多个Cluster(集群)，Nacos默认Cluster是<strong>DEFAULT</strong>，Cluster是对指定微服务的一个虚拟划分。比方说为了容灾，将Service微服务分别部署在了<strong>杭州机房</strong>和<strong>广州机房</strong>，这时就可以给杭州机房的Service微服务起一个集群名称(<strong>HZ</strong>)，给广州机房的Service微服务起一个集群名字(<strong>GZ</strong>)，还可以尽量让同一个机房的微服务互相调用，以提升性能。</li></ol> <p>最后是Instance，就是微服务的实例。</p> <h3 id="共享配置-shared-configs-和扩展配-extension-config"><a href="#共享配置-shared-configs-和扩展配-extension-config" class="header-anchor">#</a> 共享配置(shared-configs)和扩展配(extension-config)</h3> <p>日常开发中，多个模块可能会有很多共用的配置，比如数据库连接信息，Redis 连接信息，RabbitMQ 连接信息，监控配置等等。那么此时，我们就希望可以加载多个配置，多个项目共享同一个配置之类等功能，Nacos Config 也确实支持。</p> <ul><li>Nacos在配置路径<code>spring.cloud.nacos.config.extension-config</code>下，允许我们指定⼀个或多个额外配置。</li> <li>Nacos在配置路径<code>spring.cloud.nacos.config.shared-configs</code>下，允许我们指定⼀个或多个共享配置。</li></ul> <p>上述两类配置都⽀持三个属性：<code>data-id</code>、<code>group</code>(默认为字符串<code>DEFAULT_GROUP</code>)、<code>refresh</code>(默认为<code>true</code>)。</p> <div class="language-yml extra-class"><pre class="language-yml"><code>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">username</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>nacos.username<span class="token punctuation">}</span>
      <span class="token key atrule">password</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>nacos.password<span class="token punctuation">}</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>nacos.server<span class="token punctuation">-</span>addr<span class="token punctuation">}</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>nacos.namespace<span class="token punctuation">}</span>
        <span class="token comment"># 用于共享的配置文件</span>
        <span class="token key atrule">shared-configs</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> common<span class="token punctuation">-</span>mysql.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> SPRING_CLOUD_EXAMPLE_GROUP
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> common<span class="token punctuation">-</span>redis.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> SPRING_CLOUD_EXAMPLE_GROUP
        <span class="token comment"># 常规配置文件</span>
        <span class="token comment"># 优先级大于 shared-configs，在 shared-configs 之后加载</span>
        <span class="token key atrule">extension-configs</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>config<span class="token punctuation">-</span>advanced.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> SPRING_CLOUD_EXAMPLE_GROUP
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>config<span class="token punctuation">-</span>base.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> SPRING_CLOUD_EXAMPLE_GROUP
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p>参数解析：</p> <ul><li>data-id : Data Id</li> <li>group：自定义 Data Id 所在的组，不明确配置的话，默认是 DEFAULT_GROUP。</li> <li>refresh: 控制该 Data Id 在配置变更时，是否支持应用中可动态刷新， 感知到最新的配置值。默认是不支持的。</li></ul> <p>注意：这里的<code>Data ID</code>后面是加<code>.yaml</code>后缀的，且不需要指定<code>file-extension</code>。</p> <p><strong>共享配置和扩展配置的区别</strong></p> <p>实际上，Nacos中并未对<code>extension-configs</code>和<code>shared-configs</code>的差别进⾏详细阐述。我们从他们的结构，看不出本质差别；除了优先级不同以外，也没有其他差别。</p> <p><strong>Nacos对配置的默认理念</strong></p> <ul><li><code>namespace</code>区分环境：开发环境、测试环境、预发布环境、⽣产环境。</li> <li><code>group</code>区分不同应⽤：同⼀个环境内，不同应⽤的配置，通过<code>group</code>来区分。</li></ul> <p><strong>主配置是应⽤专有的配置</strong></p> <p>因此，主配置应当在<code>dataId</code>上要区分，同时最好还要有<code>group</code>的区分，因为<code>group</code>区分应⽤（虽然<code>dataId</code>上区分了，不⽤设置<code>group</code>也能按应⽤单独加载）。</p> <p><strong>要在各应⽤之间共享⼀个配置，请使⽤上⾯的 shared-configs</strong></p> <p>因此按该理念，<code>shared-configs</code>指定的配置，本来应该是不指定<code>group</code>的，也就是应当归⼊<code>DEFAULT_GROUP</code>这个公共分组。</p> <p><strong>如果要在特定范围内（⽐如某个应⽤上）覆盖某个共享dataId上的特定属性，请使⽤ extension-config</strong></p> <p>⽐如，其他应⽤的数据库url，都是⼀个固定的url，使⽤<code>shared-configs.dataId = mysql</code>的共享配置。但其中有⼀个应⽤<code>ddd-demo</code>是特例，需要为该应⽤配置扩展属性来覆盖。</p> <div class="language-yml extra-class"><pre class="language-yml"><code> <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
   <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
     <span class="token key atrule">config</span><span class="token punctuation">:</span>
       <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
       <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test2
       <span class="token key atrule">group</span><span class="token punctuation">:</span> ddd<span class="token punctuation">-</span>demo
       shared<span class="token punctuation">-</span>configs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
         <span class="token key atrule">data-id</span><span class="token punctuation">:</span> mysql.yaml
         <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
       extension<span class="token punctuation">-</span>configs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
         <span class="token key atrule">data-id</span><span class="token punctuation">:</span> mysql.yaml
         <span class="token key atrule">group</span><span class="token punctuation">:</span> ddd<span class="token punctuation">-</span>demo
         <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p><strong>关于优先级</strong></p> <p>1、上述两类配置都是数组，对同种配置，数组元素对应的下标越⼤，优先级越⾼。也就是排在后⾯的相同配置，将覆盖排在前⾯的同名配置。</p> <ul><li>同为扩展配置，存在如下优先级关系：<code>extension-configs[3] &gt; extension-configs[2] &gt; extension-configs[1] &gt; extension-configs[0</code>。</li> <li>同为共享配置，存在如下优先级关系：<code>shared-configs[3] &gt; shared-configs[2] &gt; shared-configs[1] &gt; shared-configs[0]</code>。</li></ul> <p>2、不同种类配置之间，优先级按顺序如下：主配置 &gt; 扩展配置(extension-configs) &gt; 共享配置(shared-configs)</p> <h2 id="springcloud-alibaba-sentinel服务降级熔断与限流"><a href="#springcloud-alibaba-sentinel服务降级熔断与限流" class="header-anchor">#</a> SpringCloud Alibaba Sentinel服务降级熔断与限流</h2> <p>怎么用：
下载客户端jar包运行。</p> <p>改pom</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>改yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
	<span class="token key atrule">transport</span><span class="token punctuation">:</span>
		<span class="token key atrule">dashboard</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8080</span>
		<span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8719</span>  <span class="token comment">#默认8719，应用与Sentinel控制台交互的端口，应用本地会起一个该端口占用HttpServer</span>
</code></pre></div><h3 id="流控规则"><a href="#流控规则" class="header-anchor">#</a> 流控规则</h3> <ul><li>资源名：唯一名称，默认请求路径=</li> <li>针对来源：Sentinel可以针对调用者进行限流，填写微服务名，默认default(不区分来源)</li> <li>阈值类型/单机阈值：
<ul><li>QPS（每秒钟的请求数量）：当代用该api的QPS达到阈值的时候，进行限流</li> <li>线程数：当调用改api的线程数达到阈值的时候，进行限流</li></ul></li> <li>是否集群</li> <li>流控模式：
<ul><li>直接：api达到限流条件时，直接限流</li> <li>关联：当关联的资源达到阈值时，就限流自己</li> <li>链路：只记录指定链路上的流量（制定资源从入口资源进来的流量，如果达到阈值，就进行限流）api级别的针对来源</li></ul></li> <li>流控效果
<ul><li>快速失败：直接失败，抛异常</li> <li>Warm Up:根据codeFactor（冷加载因子，默认3）的值，从阈值/codeFactor，经过预热时长，才达到设置的QPS阈值。</li> <li>排队等待：匀速排队，让请求以匀速的速度通过，阈值类型必须设置为QPS，否则无效</li></ul></li></ul> <h3 id="流控模式"><a href="#流控模式" class="header-anchor">#</a> 流控模式</h3> <ul><li><p>直接（默认）</p> <p>快速失败，QPS1,阈值1，表示1秒内查询1次就是ok。若超过次数1，就直接快速失败，报默认错误，线程同理。</p></li> <li><p>关联</p> <p>当关联的资源达到阈值时，限流自己，当与A关联的资源B达到阈值后，就限流自己</p></li> <li><p>链路</p> <p>多个请求调用了同一个微服务</p></li></ul> <h3 id="流控效果"><a href="#流控效果" class="header-anchor">#</a> 流控效果</h3> <ul><li><p>直接-&gt;快速失败（默认的流控处理）</p> <p>直接失败，抛出异常：Blocked by Sentinel (flow limiting)</p></li> <li><p>预热</p> <p>默认QPS从阈值除以coldFactor（默认值为3）开始，经过预热时长后才会达到阈值</p></li> <li><p>排队等待</p> <p>让请求以均匀的速度通过，等待超时时间，阈值类型必须设置成QPS，否则无效。</p> <h3 id="降级规则"><a href="#降级规则" class="header-anchor">#</a> 降级规则</h3></li> <li><p>慢调用比例</p> <p>简单来说就是，统计时长内的请求数中，阈值百分比的请求响应时间都大于最大RT，则系统熔断指定时长。</p></li> <li><p>异常比例</p> <p>简单来说就是，统计时长内的请求数中，比例阈值的请求出现异常，则系统熔断指定时长。半开时，如果再次访问有异常，继续熔断。</p></li> <li><p>异常数</p> <p>简单来说就是，统计时长内的请求数中，异常数超过指定的异常数，则系统熔断指定时长。半开时，如果再次访问有异常，继续熔断。</p></li></ul> <h3 id="热点key限流"><a href="#热点key限流" class="header-anchor">#</a> 热点key限流</h3> <p>对指定参数，指定参数索引进行限流，其他的不限流。</p> <h3 id="系统规则"><a href="#系统规则" class="header-anchor">#</a> 系统规则</h3> <ul><li>Load自适应：系统的load1作为启发指标，进行自适应系统保护。当系统load1超过设定的启发值，且系统当前的并发线程数超过预算的系统容量时才会触发系统保护（BBR阶段）。系统容量是由系统的maxQPS * minRt估算得出。设定参数一般是CPU cores * 2.5.</li> <li>CPU usage：当系统CPU使用率超过阈值即触发系统保护（取值范围0.0-1.0），比较灵敏</li> <li>平均 RT：当单台机器上所有入口流量的平均RT达到阈值即出发系统保护机制，单位是毫秒。</li> <li>并发线程数：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。</li> <li>入口QPS ：当单台机器上所有入口流量的QPS达到阈值即触发系统保护。</li></ul> <h3 id="sentinelresource"><a href="#sentinelresource" class="header-anchor">#</a> @SentinelResource</h3> <p>可以使用@SentinelResource指定兜底方法。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/testHotKey&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;testHotKey&quot;</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">&quot;deal_testHotKey&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testHotKey</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;p1&quot;</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> p1<span class="token punctuation">,</span>
                         <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;p2&quot;</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> p2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//int age = 10/0;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;------testHotKey&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//兜底方法</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> deal_testHotKey <span class="token punctuation">(</span><span class="token class-name">String</span> p1<span class="token punctuation">,</span> <span class="token class-name">String</span> p2<span class="token punctuation">,</span> <span class="token class-name">BlockException</span> exception<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;------deal_testHotKey,o(╥﹏╥)o&quot;</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre></div><p>每个类都要写兜底方法，代码耦合性高。代码解耦：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 自定义兜底方法</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerBlockHandler</span> <span class="token punctuation">{</span>
    
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CommonResult</span> <span class="token function">handleException</span><span class="token punctuation">(</span><span class="token class-name">BlockException</span> exception<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token punctuation">(</span><span class="token number">2020</span><span class="token punctuation">,</span><span class="token string">&quot;自定义限流处理信息.... CustomerBlockHandler --- 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CommonResult</span> <span class="token function">handleException2</span><span class="token punctuation">(</span><span class="token class-name">BlockException</span> exception<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token punctuation">(</span><span class="token number">2020</span><span class="token punctuation">,</span><span class="token string">&quot;自定义限流处理信息.... CustomerBlockHandler --- 2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/rateLimit/customerBlockHandler&quot;</span><span class="token punctuation">)</span>
		<span class="token comment">// 指定兜底方法</span>
<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;customerBlockHandler&quot;</span><span class="token punctuation">,</span>
  blockHandlerClass <span class="token operator">=</span> <span class="token class-name">CustomerBlockHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> blockHandler <span class="token operator">=</span> <span class="token string">&quot;handleException2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">CommonResult</span> <span class="token function">customerBlockHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token string">&quot;自定义处理&quot;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Payment</span><span class="token punctuation">(</span><span class="token number">2020L</span><span class="token punctuation">,</span><span class="token string">&quot;serial003&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="规则持久化"><a href="#规则持久化" class="header-anchor">#</a> 规则持久化</h3> <p>一旦我们重启应用，Sentinel规则将消失，生产环境需要将配置规则进行持久化,将限流配置规则持久化进Nacos保存，只要刷新地址，sentinel控制台的流控规则就能看到，只要Nacos里面的配置不删除，Sentinel上的流控规则持续有效</p> <p>POM</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.csp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sentinel-datasource-nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code>    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
        <span class="token key atrule">ds1</span><span class="token punctuation">:</span>
          <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
            <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
            <span class="token key atrule">dataId</span><span class="token punctuation">:</span> cloudalibaba<span class="token punctuation">-</span>sentinel<span class="token punctuation">-</span>service
            <span class="token key atrule">groupId</span><span class="token punctuation">:</span> DEFAULT_GROUP
            <span class="token key atrule">data-type</span><span class="token punctuation">:</span> json
            <span class="token key atrule">rule-type</span><span class="token punctuation">:</span> flow
</code></pre></div><p>nacos中新建相关配置：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
         <span class="token property">&quot;resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/testA&quot;</span><span class="token punctuation">,</span>
         <span class="token property">&quot;limitApp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span>
         <span class="token property">&quot;grade&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
         <span class="token property">&quot;count&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
         <span class="token property">&quot;strategy&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
         <span class="token property">&quot;controlBehavior&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
         <span class="token property">&quot;clusterMode&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.ff72da0a.js" defer></script><script src="/assets/js/2.bafebcf4.js" defer></script><script src="/assets/js/10.8d41c55a.js" defer></script>
  </body>
</html>
