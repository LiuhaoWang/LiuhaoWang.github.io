(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{313:function(t,a,s){"use strict";s.r(a);var n=s(10),e=Object(n.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"springcloud-alibaba"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#springcloud-alibaba"}},[t._v("#")]),t._v(" SpringCloud Alibaba")]),t._v(" "),a("h2",{attrs:{id:"springcloud-alibaba-nacos服务注册和配置中心"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#springcloud-alibaba-nacos服务注册和配置中心"}},[t._v("#")]),t._v(" SpringCloud Alibaba Nacos服务注册和配置中心")]),t._v(" "),a("h3",{attrs:{id:"注册中心使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注册中心使用"}},[t._v("#")]),t._v(" 注册中心使用")]),t._v(" "),a("p",[t._v("运行nacos客户端")]),t._v(" "),a("p",[t._v("改POM")]),t._v(" "),a("div",{staticClass:"language-xml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("com.alibaba.cloud"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("spring-cloud-starter-alibaba-nacos-discovery"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),a("p",[t._v("改yml")]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[t._v("  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cloud")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nacos")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("discovery")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("server-addr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//127.0.0.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8848")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#配置Nacos地址")]),t._v("\n")])])]),a("p",[t._v("主启动加入@EnableDiscoveryClient注解")]),t._v(" "),a("h3",{attrs:{id:"配置中心使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置中心使用"}},[t._v("#")]),t._v(" 配置中心使用")]),t._v(" "),a("p",[t._v("改POM")]),t._v(" "),a("div",{staticClass:"language-xml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("com.alibaba.cloud"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("spring-cloud-starter-alibaba-nacos-config"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),a("p",[t._v("改yml，Nacos同springcloud-config一样，在项目初始化时，要保证先从配置中心进行配置拉取，拉取配置之后，才能保证项目的正常启动。springboot中配置文件的加载是存在优先级顺序的，bootstrap优先级高于application。bootstrap.yml")]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[t._v("  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cloud")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nacos")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("discovery")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("server-addr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 127.0.0.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8848")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#服务注册中心地址")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("server-addr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 127.0.0.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8848")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#配置中心地址")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("file-extension")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" yaml "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#指定yaml格式的配置（yml和yaml都可以）")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 命名空间")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 508abb0a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("1cac"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("49d6"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("83f1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("f6e3f7b804c5\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 分组")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" dev_group2\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#${spring.application.name}-${spring.profiles.active}.${spring.cloud.nacos.config.file-extension}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#nacos-config-client-dev.yaml  (一定要与file-extension值保持一致)")]),t._v("\n")])])]),a("p",[t._v("application.yml")]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spring")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("profiles")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("active")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" dev\n")])])]),a("p",[t._v("主启动加入@EnableDiscoveryClient注解,调用类加入@RefreshScopee实现配置自动更新")]),t._v(" "),a("blockquote",[a("p",[t._v("云上的配置文件名称要和这个一致")]),t._v(" "),a("p",[t._v("${spring.application.name}-${spring.profiles.active}.${spring.cloud.nacos.config.file-extension}")])]),t._v(" "),a("h3",{attrs:{id:"分类配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分类配置"}},[t._v("#")]),t._v(" 分类配置")]),t._v(" "),a("p",[t._v("Namespace+Group+Data ID三者完成分类配置")]),t._v(" "),a("p",[t._v("默认情况：Namespace=public，Group=DEFAULT_GROUP，默认Cluster是DEFAULT，Data ID就是配置文件的名称")]),t._v(" "),a("ol",[a("li",[t._v("Nacos默认的命名空间是public，Namespace主要用来实现隔离。比方说我们现在有三个环境："),a("strong",[t._v("开发、测试、生产环境")]),t._v("，我们就可以创建三个Namespace，不同的 Namespace之间是隔离的。")]),t._v(" "),a("li",[t._v("Group默认是"),a("strong",[t._v("DEFAULT_GROUP")]),t._v("，Group可以把不同的微服务划分到同一个分组里面去。Service就是微服务，一个Service可以包含多个Cluster(集群)，Nacos默认Cluster是"),a("strong",[t._v("DEFAULT")]),t._v("，Cluster是对指定微服务的一个虚拟划分。比方说为了容灾，将Service微服务分别部署在了"),a("strong",[t._v("杭州机房")]),t._v("和"),a("strong",[t._v("广州机房")]),t._v("，这时就可以给杭州机房的Service微服务起一个集群名称("),a("strong",[t._v("HZ")]),t._v(")，给广州机房的Service微服务起一个集群名字("),a("strong",[t._v("GZ")]),t._v(")，还可以尽量让同一个机房的微服务互相调用，以提升性能。")])]),t._v(" "),a("p",[t._v("最后是Instance，就是微服务的实例。")]),t._v(" "),a("h3",{attrs:{id:"共享配置-shared-configs-和扩展配-extension-config"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#共享配置-shared-configs-和扩展配-extension-config"}},[t._v("#")]),t._v(" 共享配置(shared-configs)和扩展配(extension-config)")]),t._v(" "),a("p",[t._v("日常开发中，多个模块可能会有很多共用的配置，比如数据库连接信息，Redis 连接信息，RabbitMQ 连接信息，监控配置等等。那么此时，我们就希望可以加载多个配置，多个项目共享同一个配置之类等功能，Nacos Config 也确实支持。")]),t._v(" "),a("ul",[a("li",[t._v("Nacos在配置路径"),a("code",[t._v("spring.cloud.nacos.config.extension-config")]),t._v("下，允许我们指定⼀个或多个额外配置。")]),t._v(" "),a("li",[t._v("Nacos在配置路径"),a("code",[t._v("spring.cloud.nacos.config.shared-configs")]),t._v("下，允许我们指定⼀个或多个共享配置。")])]),t._v(" "),a("p",[t._v("上述两类配置都⽀持三个属性："),a("code",[t._v("data-id")]),t._v("、"),a("code",[t._v("group")]),t._v("(默认为字符串"),a("code",[t._v("DEFAULT_GROUP")]),t._v(")、"),a("code",[t._v("refresh")]),t._v("(默认为"),a("code",[t._v("true")]),t._v(")。")]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[t._v("  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cloud")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nacos")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("username")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("nacos.username"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("nacos.password"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("server-addr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("nacos.server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("addr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("nacos.namespace"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 用于共享的配置文件")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shared-configs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("data-id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" common"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("mysql.yaml\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" SPRING_CLOUD_EXAMPLE_GROUP\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("data-id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" common"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("redis.yaml\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" SPRING_CLOUD_EXAMPLE_GROUP\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 常规配置文件")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 优先级大于 shared-configs，在 shared-configs 之后加载")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("extension-configs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("data-id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nacos"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("advanced.yaml\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" SPRING_CLOUD_EXAMPLE_GROUP\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("refresh")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("data-id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nacos"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("base.yaml\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" SPRING_CLOUD_EXAMPLE_GROUP\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("refresh")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n")])])]),a("p",[t._v("参数解析：")]),t._v(" "),a("ul",[a("li",[t._v("data-id : Data Id")]),t._v(" "),a("li",[t._v("group：自定义 Data Id 所在的组，不明确配置的话，默认是 DEFAULT_GROUP。")]),t._v(" "),a("li",[t._v("refresh: 控制该 Data Id 在配置变更时，是否支持应用中可动态刷新， 感知到最新的配置值。默认是不支持的。")])]),t._v(" "),a("p",[t._v("注意：这里的"),a("code",[t._v("Data ID")]),t._v("后面是加"),a("code",[t._v(".yaml")]),t._v("后缀的，且不需要指定"),a("code",[t._v("file-extension")]),t._v("。")]),t._v(" "),a("p",[a("strong",[t._v("共享配置和扩展配置的区别")])]),t._v(" "),a("p",[t._v("实际上，Nacos中并未对"),a("code",[t._v("extension-configs")]),t._v("和"),a("code",[t._v("shared-configs")]),t._v("的差别进⾏详细阐述。我们从他们的结构，看不出本质差别；除了优先级不同以外，也没有其他差别。")]),t._v(" "),a("p",[a("strong",[t._v("Nacos对配置的默认理念")])]),t._v(" "),a("ul",[a("li",[a("code",[t._v("namespace")]),t._v("区分环境：开发环境、测试环境、预发布环境、⽣产环境。")]),t._v(" "),a("li",[a("code",[t._v("group")]),t._v("区分不同应⽤：同⼀个环境内，不同应⽤的配置，通过"),a("code",[t._v("group")]),t._v("来区分。")])]),t._v(" "),a("p",[a("strong",[t._v("主配置是应⽤专有的配置")])]),t._v(" "),a("p",[t._v("因此，主配置应当在"),a("code",[t._v("dataId")]),t._v("上要区分，同时最好还要有"),a("code",[t._v("group")]),t._v("的区分，因为"),a("code",[t._v("group")]),t._v("区分应⽤（虽然"),a("code",[t._v("dataId")]),t._v("上区分了，不⽤设置"),a("code",[t._v("group")]),t._v("也能按应⽤单独加载）。")]),t._v(" "),a("p",[a("strong",[t._v("要在各应⽤之间共享⼀个配置，请使⽤上⾯的 shared-configs")])]),t._v(" "),a("p",[t._v("因此按该理念，"),a("code",[t._v("shared-configs")]),t._v("指定的配置，本来应该是不指定"),a("code",[t._v("group")]),t._v("的，也就是应当归⼊"),a("code",[t._v("DEFAULT_GROUP")]),t._v("这个公共分组。")]),t._v(" "),a("p",[a("strong",[t._v("如果要在特定范围内（⽐如某个应⽤上）覆盖某个共享dataId上的特定属性，请使⽤ extension-config")])]),t._v(" "),a("p",[t._v("⽐如，其他应⽤的数据库url，都是⼀个固定的url，使⽤"),a("code",[t._v("shared-configs.dataId = mysql")]),t._v("的共享配置。但其中有⼀个应⽤"),a("code",[t._v("ddd-demo")]),t._v("是特例，需要为该应⽤配置扩展属性来覆盖。")]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cloud")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nacos")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n     "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n       "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("server-addr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" localhost"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8848")]),t._v("\n       "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test2\n       "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ddd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("demo\n       shared"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("configs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("data-id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mysql.yaml\n         "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("refresh")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n       extension"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("configs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("data-id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mysql.yaml\n         "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ddd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("demo\n         "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("refresh")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n")])])]),a("p",[a("strong",[t._v("关于优先级")])]),t._v(" "),a("p",[t._v("1、上述两类配置都是数组，对同种配置，数组元素对应的下标越⼤，优先级越⾼。也就是排在后⾯的相同配置，将覆盖排在前⾯的同名配置。")]),t._v(" "),a("ul",[a("li",[t._v("同为扩展配置，存在如下优先级关系："),a("code",[t._v("extension-configs[3] > extension-configs[2] > extension-configs[1] > extension-configs[0")]),t._v("。")]),t._v(" "),a("li",[t._v("同为共享配置，存在如下优先级关系："),a("code",[t._v("shared-configs[3] > shared-configs[2] > shared-configs[1] > shared-configs[0]")]),t._v("。")])]),t._v(" "),a("p",[t._v("2、不同种类配置之间，优先级按顺序如下：主配置 > 扩展配置(extension-configs) > 共享配置(shared-configs)")]),t._v(" "),a("h2",{attrs:{id:"springcloud-alibaba-sentinel服务降级熔断与限流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#springcloud-alibaba-sentinel服务降级熔断与限流"}},[t._v("#")]),t._v(" SpringCloud Alibaba Sentinel服务降级熔断与限流")]),t._v(" "),a("p",[t._v("怎么用：\n下载客户端jar包运行。")]),t._v(" "),a("p",[t._v("改pom")]),t._v(" "),a("div",{staticClass:"language-xml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("com.alibaba.cloud"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("spring-cloud-starter-alibaba-sentinel"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),a("p",[t._v("改yml")]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("sentinel")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("transport")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dashboard")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" localhost"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8719")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#默认8719，应用与Sentinel控制台交互的端口，应用本地会起一个该端口占用HttpServer")]),t._v("\n")])])]),a("h3",{attrs:{id:"流控规则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#流控规则"}},[t._v("#")]),t._v(" 流控规则")]),t._v(" "),a("ul",[a("li",[t._v("资源名：唯一名称，默认请求路径=")]),t._v(" "),a("li",[t._v("针对来源：Sentinel可以针对调用者进行限流，填写微服务名，默认default(不区分来源)")]),t._v(" "),a("li",[t._v("阈值类型/单机阈值：\n"),a("ul",[a("li",[t._v("QPS（每秒钟的请求数量）：当代用该api的QPS达到阈值的时候，进行限流")]),t._v(" "),a("li",[t._v("线程数：当调用改api的线程数达到阈值的时候，进行限流")])])]),t._v(" "),a("li",[t._v("是否集群")]),t._v(" "),a("li",[t._v("流控模式：\n"),a("ul",[a("li",[t._v("直接：api达到限流条件时，直接限流")]),t._v(" "),a("li",[t._v("关联：当关联的资源达到阈值时，就限流自己")]),t._v(" "),a("li",[t._v("链路：只记录指定链路上的流量（制定资源从入口资源进来的流量，如果达到阈值，就进行限流）api级别的针对来源")])])]),t._v(" "),a("li",[t._v("流控效果\n"),a("ul",[a("li",[t._v("快速失败：直接失败，抛异常")]),t._v(" "),a("li",[t._v("Warm Up:根据codeFactor（冷加载因子，默认3）的值，从阈值/codeFactor，经过预热时长，才达到设置的QPS阈值。")]),t._v(" "),a("li",[t._v("排队等待：匀速排队，让请求以匀速的速度通过，阈值类型必须设置为QPS，否则无效")])])])]),t._v(" "),a("h3",{attrs:{id:"流控模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#流控模式"}},[t._v("#")]),t._v(" 流控模式")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("直接（默认）")]),t._v(" "),a("p",[t._v("快速失败，QPS1,阈值1，表示1秒内查询1次就是ok。若超过次数1，就直接快速失败，报默认错误，线程同理。")])]),t._v(" "),a("li",[a("p",[t._v("关联")]),t._v(" "),a("p",[t._v("当关联的资源达到阈值时，限流自己，当与A关联的资源B达到阈值后，就限流自己")])]),t._v(" "),a("li",[a("p",[t._v("链路")]),t._v(" "),a("p",[t._v("多个请求调用了同一个微服务")])])]),t._v(" "),a("h3",{attrs:{id:"流控效果"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#流控效果"}},[t._v("#")]),t._v(" 流控效果")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("直接->快速失败（默认的流控处理）")]),t._v(" "),a("p",[t._v("直接失败，抛出异常：Blocked by Sentinel (flow limiting)")])]),t._v(" "),a("li",[a("p",[t._v("预热")]),t._v(" "),a("p",[t._v("默认QPS从阈值除以coldFactor（默认值为3）开始，经过预热时长后才会达到阈值")])]),t._v(" "),a("li",[a("p",[t._v("排队等待")]),t._v(" "),a("p",[t._v("让请求以均匀的速度通过，等待超时时间，阈值类型必须设置成QPS，否则无效。")]),t._v(" "),a("h3",{attrs:{id:"降级规则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#降级规则"}},[t._v("#")]),t._v(" 降级规则")])]),t._v(" "),a("li",[a("p",[t._v("慢调用比例")]),t._v(" "),a("p",[t._v("简单来说就是，统计时长内的请求数中，阈值百分比的请求响应时间都大于最大RT，则系统熔断指定时长。")])]),t._v(" "),a("li",[a("p",[t._v("异常比例")]),t._v(" "),a("p",[t._v("简单来说就是，统计时长内的请求数中，比例阈值的请求出现异常，则系统熔断指定时长。半开时，如果再次访问有异常，继续熔断。")])]),t._v(" "),a("li",[a("p",[t._v("异常数")]),t._v(" "),a("p",[t._v("简单来说就是，统计时长内的请求数中，异常数超过指定的异常数，则系统熔断指定时长。半开时，如果再次访问有异常，继续熔断。")])])]),t._v(" "),a("h3",{attrs:{id:"热点key限流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#热点key限流"}},[t._v("#")]),t._v(" 热点key限流")]),t._v(" "),a("p",[t._v("对指定参数，指定参数索引进行限流，其他的不限流。")]),t._v(" "),a("h3",{attrs:{id:"系统规则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#系统规则"}},[t._v("#")]),t._v(" 系统规则")]),t._v(" "),a("ul",[a("li",[t._v("Load自适应：系统的load1作为启发指标，进行自适应系统保护。当系统load1超过设定的启发值，且系统当前的并发线程数超过预算的系统容量时才会触发系统保护（BBR阶段）。系统容量是由系统的maxQPS * minRt估算得出。设定参数一般是CPU cores * 2.5.")]),t._v(" "),a("li",[t._v("CPU usage：当系统CPU使用率超过阈值即触发系统保护（取值范围0.0-1.0），比较灵敏")]),t._v(" "),a("li",[t._v("平均 RT：当单台机器上所有入口流量的平均RT达到阈值即出发系统保护机制，单位是毫秒。")]),t._v(" "),a("li",[t._v("并发线程数：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。")]),t._v(" "),a("li",[t._v("入口QPS ：当单台机器上所有入口流量的QPS达到阈值即触发系统保护。")])]),t._v(" "),a("h3",{attrs:{id:"sentinelresource"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sentinelresource"}},[t._v("#")]),t._v(" @SentinelResource")]),t._v(" "),a("p",[t._v("可以使用@SentinelResource指定兜底方法。")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@GetMapping")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/testHotKey"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@SentinelResource")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"testHotKey"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("blockHandler "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"deal_testHotKey"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("testHotKey")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@RequestParam")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"p1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("required "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" p1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                         "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@RequestParam")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"p2"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("required "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" p2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//int age = 10/0;")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"------testHotKey"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//兜底方法")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" deal_testHotKey "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" p1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" p2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BlockException")]),t._v(" exception"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"------deal_testHotKey,o(╥﹏╥)o"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("每个类都要写兜底方法，代码耦合性高。代码解耦：")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 自定义兜底方法")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CustomerBlockHandler")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CommonResult")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("handleException")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BlockException")]),t._v(" exception"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CommonResult")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"自定义限流处理信息.... CustomerBlockHandler --- 1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CommonResult")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("handleException2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BlockException")]),t._v(" exception"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CommonResult")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"自定义限流处理信息.... CustomerBlockHandler --- 2"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@GetMapping")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/rateLimit/customerBlockHandler"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 指定兜底方法")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@SentinelResource")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"customerBlockHandler"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  blockHandlerClass "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CustomerBlockHandler")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" blockHandler "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"handleException2"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CommonResult")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("customerBlockHandler")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CommonResult")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"自定义处理"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Payment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020L")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"serial003"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"规则持久化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#规则持久化"}},[t._v("#")]),t._v(" 规则持久化")]),t._v(" "),a("p",[t._v("一旦我们重启应用，Sentinel规则将消失，生产环境需要将配置规则进行持久化,将限流配置规则持久化进Nacos保存，只要刷新地址，sentinel控制台的流控规则就能看到，只要Nacos里面的配置不删除，Sentinel上的流控规则持续有效")]),t._v(" "),a("p",[t._v("POM")]),t._v(" "),a("div",{staticClass:"language-xml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("com.alibaba.csp"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("sentinel-datasource-nacos"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),a("p",[t._v("yml")]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("sentinel")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("datasource")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ds1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nacos")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("server-addr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 127.0.0.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8848")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dataId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" cloudalibaba"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("sentinel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("service\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" DEFAULT_GROUP\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("data-type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" json\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rule-type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" flow\n")])])]),a("p",[t._v("nacos中新建相关配置：")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"resource"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/testA"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"limitApp"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"default"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"grade"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"count"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"strategy"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"controlBehavior"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"clusterMode"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v(" \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])])])}),[],!1,null,null,null);a.default=e.exports}}]);